<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Status</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <h1>Chat Status</h1>

        <div class="status-display" id="all-users-status">
            <p>Loading user statuses...</p>
        </div>

        <div class="controls">
            <h2>Your Status</h2>
            <label class="switch">
                <input type="checkbox" id="status-toggle">
                <span class="slider round"></span>
            </label>
            <p id="current-status-text">Set to: No Chat</p>
        </div>

        <div class="auth-container">
            <h2>Sign Up</h2>
            <div class="form-group">
                <label for="signup-email">Email:</label>
                <input type="email" id="signup-email" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="signup-password">Password:</label>
                <input type="password" id="signup-password" placeholder="Enter your password">
            </div>
            <button id="signup-button">Sign Up</button>

            <h2>Log In</h2>
            <div class="form-group">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="login-password">Password:</label>
                <input type="password" id="login-password" placeholder="Enter your password">
            </div>
            <button id="login-button">Log In</button>

            <button id="logout-button">Log Out</button>
            <div id="auth-status"></div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";

        // Your web app's Firebase configuration (NEW PROJECT)
        const firebaseConfig = {
            apiKey: "AIzaSyAO-BoxQrr2hKD1T3F9BqR4WCeca5VcsOw",
            authDomain: "coffee-chat-again.firebaseapp.com",
            projectId: "coffee-chat-again",
            storageBucket: "coffee-chat-again.firebasestorage.app",
            messagingSenderId: "705055102684",
            appId: "1:705055102684:web:884100f5a0ce14ee344619"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app); // Initialize Firebase Authentication

        // Get HTML elements
        const statusToggle = document.getElementById('status-toggle');
        const currentStatusText = document.getElementById('current-status-text');
        const allUsersStatusDiv = document.getElementById('all-users-status'); // New element for dynamic display
        const authStatusDiv = document.getElementById('auth-status');

        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupButton = document.getElementById('signup-button');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');

        let loggedInUserId = null; // To store the current user's UID

        // --- Firebase Authentication Functions ---

        async function signUpUser(email, password) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("User signed up:", user);
                authStatusDiv.textContent = `Signed up as: ${user.email} (UID: ${user.uid})`;

                // Initialize user data in Realtime Database, including email
                await set(ref(database, `users/${user.uid}`), {
                    email: user.email,
                    status: 'no_chat'
                });
                console.log(`Initial status set for new user: ${user.email}`);

            } catch (error) {
                console.error("Error signing up:", error.message);
                authStatusDiv.textContent = `Sign up error: ${error.message}`;
            }
        }

        async function logInUser(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("User logged in:", user);
                authStatusDiv.textContent = `Logged in as: ${user.email} (UID: ${user.uid})`;
                // No need to set initial status here, it should already exist from signup
            } catch (error) {
                console.error("Error logging in:", error.message);
                authStatusDiv.textContent = `Log in error: ${error.message}`;
            }
        }

        async function logOutUser() {
            try {
                await signOut(auth);
                console.log("User logged out");
                authStatusDiv.textContent = 'Logged out';
                // Reset UI elements or hide user-specific content
                statusToggle.checked = false;
                currentStatusText.textContent = 'Set to: No Chat';
                allUsersStatusDiv.innerHTML = '<p>Loading user statuses...</p>'; // Clear dynamic user list
            } catch (error) {
                console.error("Error logging out:", error.message);
                authStatusDiv.textContent = `Log out error: ${error.message}`;
            }
        }

        // --- Realtime Database Interaction Functions ---

        // This function will listen to the entire 'users' node
        // and dynamically update the display for ALL users.
        function setupAllUsersStatusListener() {
            const usersRef = ref(database, 'users');
            onValue(usersRef, (snapshot) => {
                const usersData = snapshot.val(); // Get all users data
                allUsersStatusDiv.innerHTML = ''; // Clear previous list

                if (usersData) {
                    for (const uid in usersData) {
                        if (usersData.hasOwnProperty(uid)) {
                            const user = usersData[uid];
                            const userEmail = user.email || 'Unknown User'; // Use email or a placeholder
                            const userStatus = user.status === 'chat' ? 'Available' : 'Not Available';

                            const p = document.createElement('p');
                            p.textContent = `${userEmail} Status: `;
                            const span = document.createElement('span');
                            span.id = `status-${uid}`; // Give it a unique ID based on UID
                            span.textContent = userStatus;
                            p.appendChild(span);

                            allUsersStatusDiv.appendChild(p);
                        }
                    }
                } else {
                    allUsersStatusDiv.innerHTML = '<p>No users found in the database.</p>';
                }
            });
        }

        // Handles the toggle change for the CURRENTLY LOGGED-IN user
        function handleToggleChange() {
            if (auth.currentUser) {
                const isChecked = statusToggle.checked;
                const newStatus = isChecked ? 'chat' : 'no_chat';
                const currentUserStatusRef = ref(database, `users/${auth.currentUser.uid}/status`);
                set(currentUserStatusRef, newStatus);
                currentStatusText.textContent = `Set to: ${isChecked ? 'Chat' : 'No Chat'}`; // Update local UI
            } else {
                alert("You must be logged in to change your status.");
                statusToggle.checked = false; // Reset the toggle if not logged in
            }
        }

        // --- Authentication State Observer ---
        onAuthStateChanged(auth, (user) => {
            loggedInUserId = user ? user.uid : null;

            if (user) {
                console.log("User is signed in:", user.uid);
                authStatusDiv.textContent = `Logged in as: ${user.email} (UID: ${user.uid})`;

                // Listen to THIS user's specific status to update the toggle and "Your Status" text
                const currentUserStatusRef = ref(database, `users/${user.uid}/status`);
                onValue(currentUserStatusRef, (snapshot) => {
                    const status = snapshot.val();
                    if (status !== null) { // Only update if status exists
                        statusToggle.checked = status === 'chat';
                        currentStatusText.textContent = `Set to: ${status === 'chat' ? 'Chat' : 'No Chat'}`;
                    } else {
                        // If no status, default to no_chat and update DB (e.g., first login)
                        set(currentUserStatusRef, 'no_chat');
                        statusToggle.checked = false;
                        currentStatusText.textContent = 'Set to: No Chat';
                    }
                });

                // Ensure initial status is set if not already
                set(currentUserStatusRef, statusToggle.checked ? 'chat' : 'no_chat');

            } else {
                console.log("User is signed out");
                authStatusDiv.textContent = 'Logged out';
                // Reset toggle and status text when logged out
                statusToggle.checked = false;
                currentStatusText.textContent = 'Set to: No Chat';
            }

            // Always setup the listener for all users, regardless of login state
            // (You might want to restrict this based on login for a real app,
            // but for now, it shows everyone's status if they exist in DB)
            setupAllUsersStatusListener();
        });


        // --- Event Listeners ---
        statusToggle.addEventListener('change', handleToggleChange);
        signupButton.addEventListener('click', () => {
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            signUpUser(email, password);
        });
        loginButton.addEventListener('click', () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            logInUser(email, password);
        });
        logoutButton.addEventListener('click', () => {
            logOutUser();
        });

    </script>
</body>
</html>